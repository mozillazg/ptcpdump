version: 2.1

executors:
  ubuntu-20-04:
    machine:
      image: ubuntu-2004:2024.04.4
  ubuntu-22-04:
    machine:
      image: ubuntu-2204:2024.04.4

jobs:
  arm64-e2e:
    parameters:
      os:
        type: executor
    resource_class: arm.medium
    executor: << parameters.os >>

    steps:
      - checkout
      - restore_cache:
          keys:
            - go-mod-v4-{{ checksum "go.sum" }}
      - run:
          name: Install Dependencies
          command: go mod download
      - save_cache:
          key: go-mod-v4-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"

      - run:
          name: install deps
          command: |
            sudo apt-get update && sudo apt-get install -y gcc flex bison make libelf-dev
            make libpcap

      - run:
          name: build
          command: |
            make build

            echo '========== info =========='
            uname -a
            cat /etc/issue
            file ./ptcpdump

      - run:
          name: e2e (test base)
          command: |
            sudo bash testdata/test_default.sh ./ptcpdump
            sudo bash testdata/test_base.sh ./ptcpdump
            sudo bash testdata/test_parent_info.sh ./ptcpdump

      - run:
          name: e2e (test pname filter)
          command: |
            sudo bash testdata/test_pname_filter.sh ./ptcpdump

      - run:
          name: e2e (test pid filter)
          command: |
            sudo bash testdata/test_pid_filter.sh ./ptcpdump

      - run:
          name: e2e (test read pcap)
          command: |
            sudo bash testdata/test_read_pcap.sh ./ptcpdump

      - run:
          name: e2e (test write pcap)
          command: |
            sudo bash testdata/test_write_pcap.sh ./ptcpdump

      - run:
          name: e2e (test_arp.sh)
          command: |
            sudo bash testdata/test_arp.sh ./ptcpdump
            sudo bash testdata/test_icmp.sh ./ptcpdump

      - run:
          name: e2e (test sub-program)
          command: |
            sudo bash testdata/test_sub_program.sh ./ptcpdump
            sudo bash testdata/test_sub_curl_domain_program.sh ./ptcpdump

      - run:
          name: e2e (test write stdout)
          command: |
            sudo bash testdata/test_write_stdout.sh ./ptcpdump

      - run:
          name: e2e (test nat)
          command: |
            sudo bash testdata/test_nat.sh ./ptcpdump

  docker-e2e:
    machine:
      image: ubuntu-2204:2024.04.4
    steps:
      - checkout
      - restore_cache:
          keys:
            - go-mod-v4-{{ checksum "go.sum" }}
      - run:
          name: Install Dependencies
          command: go mod download
      - save_cache:
          key: go-mod-v4-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - run:
          name: install deps
          command: |
            sudo apt-get update && sudo apt-get install -y gcc flex bison make libelf-dev
            make libpcap
      - run:
          name: build
          command: |
            make build

            echo '========== info =========='
            uname -a
            cat /etc/issue
            file ./ptcpdump
      - run:
          name: test docker
          command: |
            sudo bash testdata/test_docker.sh ./ptcpdump

      - run:
          name: test filter by container id
          command: |
            sudo bash testdata/test_docker_container_id_filter.sh ./ptcpdump

      - run:
          name: test docker filter by container name
          command: |
            sudo bash testdata/test_docker_container_name_filter.sh ./ptcpdump

  containerd-e2e:
    machine:
      image: ubuntu-2204:2024.04.4
    steps:
      - checkout
      - run:
          name: setup containerd
          command: |
            wget https://github.com/containerd/nerdctl/releases/download/v1.7.6/nerdctl-1.7.6-linux-amd64.tar.gz
            sudo tar Cxzvvf /usr/local/bin nerdctl-1.7.6-linux-amd64.tar.gz

            wget https://github.com/containernetworking/plugins/releases/download/v1.5.0/cni-plugins-linux-amd64-v1.5.0.tgz
            sudo mkdir -p /opt/cni/bin
            sudo tar Cxzvvf /opt/cni/bin cni-plugins-linux-amd64-v1.5.0.tgz
      - restore_cache:
          keys:
            - go-mod-v4-{{ checksum "go.sum" }}
      - run:
          name: Install Dependencies
          command: go mod download
      - save_cache:
          key: go-mod-v4-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - run:
          name: install deps
          command: |
            sudo apt-get update && sudo apt-get install -y gcc flex bison make libelf-dev
            make libpcap
      - run:
          name: build
          command: |
            make build

            echo '========== info =========='
            uname -a
            cat /etc/issue
            file ./ptcpdump
      - run:
          name: test containerd
          command: |
            sudo bash testdata/test_containerd.sh ./ptcpdump

      - run:
          name: test containerd filter by container id
          command: |
            sudo bash testdata/test_containerd_container_id_filter.sh ./ptcpdump

      - run:
          name: test containerd filter by container name
          command: |
            sudo bash testdata/test_containerd_container_name_filter.sh ./ptcpdump

  k8s-1-30-e2e:
    machine:
      image: ubuntu-2204:2024.04.4
    steps:
      - checkout
      - run:
          name: setup kind
          command: |
            wget https://github.com/kubernetes-sigs/kind/releases/download/v0.23.0/kind-linux-amd64
            chmod +x kind-linux-amd64
            sudo cp ./kind-linux-amd64 /usr/local/bin/kind

            IMG=kindest/node:v1.30.0@sha256:047357ac0cfea04663786a612ba1eaba9702bef25227a794b52890dd8bcd692e
            sudo docker pull "${IMG}"
            sudo docker pull alpine:3.18

            sudo kind create cluster
            sudo kind load docker-image alpine:3.18
            sudo kind export kubeconfig

      - restore_cache:
          keys:
            - go-mod-v4-{{ checksum "go.sum" }}
      - run:
          name: Install Dependencies
          command: go mod download
      - save_cache:
          key: go-mod-v4-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - run:
          name: install deps
          command: |
            sudo apt-get update && sudo apt-get install -y gcc flex bison make libelf-dev
            make libpcap
      - run:
          name: build
          command: |
            make build

            echo '========== info =========='
            uname -a
            cat /etc/issue
            file ./ptcpdump
      - run:
          name: test k8s
          command: |
            sudo bash testdata/run_test_k8s.sh

      - run:
          name: test k8s filter by container id
          command: |
            sudo bash testdata/run_test_k8s_filter_by_container.sh

      - run:
          name: test k8s filter by pod name
          command: |
            sudo bash testdata/run_test_k8s_filter_by_pod.sh

  k8s-1-20-e2e:
    machine:
      image: ubuntu-2204:2024.04.4
    steps:
      - checkout
      - run:
          name: setup kind
          command: |
            wget https://github.com/kubernetes-sigs/kind/releases/download/v0.10.0/kind-linux-amd64
            chmod +x kind-linux-amd64
            sudo cp ./kind-linux-amd64 /usr/local/bin/kind

            IMG=kindest/node:v1.20.2@sha256:8f7ea6e7642c0da54f04a7ee10431549c0257315b3a634f6ef2fecaaedb19bab
            sudo docker pull "${IMG}"
            sudo docker pull alpine:3.18

            sudo kind create cluster
            sudo kind load docker-image alpine:3.18
            sudo kind export kubeconfig

            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
            sudo kubectl config use-context kind-kind
            mkdir -p ~/.kube/
            sudo cp /root/.kube/config ~/.kube/
            sudo chown $USER ~/.kube/config
            docker cp ~/.kube/config kind-control-plane:/root/.kube/
            docker exec kind-control-plane sh -c "kubectl config set clusters.kind-kind.server https://127.0.0.1:6443"

      - restore_cache:
          keys:
            - go-mod-v4-{{ checksum "go.sum" }}
      - run:
          name: Install Dependencies
          command: go mod download
      - save_cache:
          key: go-mod-v4-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - run:
          name: install deps
          command: |
            sudo apt-get update && sudo apt-get install -y gcc flex bison make libelf-dev
            make libpcap
      - run:
          name: build
          command: |
            make build

            echo '========== info =========='
            uname -a
            cat /etc/issue
            file ./ptcpdump
      - run:
          name: test k8s
          command: |
            sudo bash testdata/run_test_k8s.sh

      - run:
          name: test k8s filter by container id
          command: |
            sudo bash testdata/run_test_k8s_filter_by_container.sh

      - run:
          name: test k8s filter by pod name
          command: |
            sudo bash testdata/run_test_k8s_filter_by_pod.sh

workflows:
  e2e:
    jobs:
      - arm64-e2e:
          matrix:
            parameters:
              os:
                - ubuntu-20-04
                - ubuntu-22-04
      - docker-e2e
      - containerd-e2e
      - k8s-1-30-e2e
      - k8s-1-20-e2e
